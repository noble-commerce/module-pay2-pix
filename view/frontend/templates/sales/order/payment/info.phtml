<?php

/**
 * DISCLAIMER
 *
 * Do not edit this file if you want to update this module for future new versions.
 *
 * @category Pay2
 * @package Pay2_Pix
 * @copyright Copyright (c) 2022 NobleCommerce
 * @author NobleCommerce <hello@noblecommerce.io>
 *
 * See LICENSE.md for license details.
 */

declare(strict_types=1);

/** @var \Pay2\Pix\Block\Info $block */
/** @var \Magento\Framework\Escaper $escaper */
/** @var \Magento\Framework\View\Helper\SecureHtmlRenderer $secureRenderer */

$storeId = $block->getInfo()->getOrder()->getStoreId();
$paymentTitle = $block->getMethod()->getConfigData('title', $storeId);
$qrCodeImage = $block->getInfo()->getAdditionalInformation('qr_code_image');
$qrCodeText = $block->getInfo()->getAdditionalInformation('text_content');
$isOrderPage = $block->getRequest()->getActionName() === 'view';
?>
<dl class="payment-method">
    <dt class="title"><?= $escaper->escapeHtml($paymentTitle) ?></dt>
    <dd class="content">
        <p>
            <b><?= /* @noEscape */ __('Status') ?>:</b>
            <?php if ($block->isPaymentPaid()) : ?>
                <?= /* @noEscape */ __('Paid') ?>
            <?php elseif ($block->isPaymentRefunded()) : ?>
                <?= /* @noEscape */ __('Refunded') ?>
            <?php elseif ($block->isPaymentExpired()) : ?>
                <?= /* @noEscape */ __('Expired') ?>
            <?php else : ?>
                <?= /* @noEscape */ __('Waiting') ?>
            <?php endif ?>
        </p>
        <?php if ($block->isPaymentPending()) : ?>
            <?php if (!empty($qrCodeImage)) : ?>
            <p>
                <b><?= /* @noEscape */ __('QR Code') ?>:</b><br/>
                <img style="border: 1px solid #000; margin: 10px 0; max-width: 240px; max-height: 240px;" src="<?= /* @noEscape */ $qrCodeImage ?>" alt="<?= /* @noEscape */ __('QR Code') ?>" />
            </p>
            <?php endif ?>
            <p>
                <b><?= /* @noEscape */ __('Pix Code') ?>:</b><br/>
                <span style="max-width: 240px; word-break: break-all; margin: 10px 0; display: block">
                    <?= /* @noEscape */ trim($qrCodeText) ?>
                </span>

                <?php if( $isOrderPage ): ?>
                    <button class="pix-button-copy" data-clipboard-text="<?= /* @noEscape */ trim($qrCodeText) ?>">
                        <?= /* @noEscape */ __('Copy Pix') ?>
                    </button>
                <?php endif ?>
            </p>
        <?php endif ?>
    </dd>
</dl>

<?php
$copiedText = __('Pix code copied!');
$scriptString = <<<script
require([
    'jquery',
    'mage/mage'
], function($){

    $('.pix-button-copy').on('click', function(e){
        e.preventDefault();
        var text = this.dataset.clipboardText;
        navigator.clipboard.writeText(text).then(function(){
            alert('${copiedText}');
        }, function(err) {
            alert(err.message);
            console.error('Could not copy pix text: ', err);
        });
    });

});
script;
?>

<?php if( $isOrderPage ): ?>
    <?= /* @noEscape */ $secureRenderer->renderTag('script', [], $scriptString, false) ?>
<?php endif ?>
