<?php

/**
 * DISCLAIMER
 *
 * Do not edit this file if you want to update this module for future new versions.
 *
 * @category Pay2
 * @package Pay2_Pix
 * @copyright Copyright (c) 2022 NobleCommerce
 * @author NobleCommerce <hello@noblecommerce.io>
 *
 * See LICENSE.md for license details.
 */

declare(strict_types=1);

/** @var \Pay2\Pix\Block\Checkout\Success $block  */

if ($block->getPayment()->getMethod() !== \Pay2\Pix\Model\Checkout\ConfigProvider::CODE) {
    return;
}

$qrCodeImage = $block->getPayment()->getAdditionalInformation('qr_code_image');
$qrCodeText = $block->getPayment()->getAdditionalInformation('text_content');
?>
<div class="pay2-success-page">

    <div class="pix-instructions">
        <p><?= /* @noEscape */ __('To pay, scan the QR Code or click the button below to copy the Pix code.') ?></p>
    </div>

    <div class="pix-columns">
        <?php if (!empty($qrCodeImage)) : ?>
            <div class="pix-column pix-column-image">
                <p><b><?= /* @noEscape */ __('QR Code') ?></b></p>
                <p class="pix-qr-code-image">
                    <img src="<?=  /* @noEscape */ $qrCodeImage ?>" alt="<?= /* @noEscape */ __('QR Code') ?>" />
                </p>
            </div>
        <?php endif; ?>

        <div class="pix-column pix-column-text">
            <p><b><?= /* @noEscape */ __('Pix Copy and Paste') ?></b></p>
            <p class="pix-qr-code-text">
                <span class="pix-qr-code-text-code">
                    <?= /* @noEscape */ $qrCodeText ?>
                </span>
                <span class="pix-qr-code-text-message">
                    <?= /* @noEscape */ __('Pix code copied!') ?>
                </span>
            </p>
            <p class="pix-copy-paste">
                <button class="action primary pix-button-copy" data-clipboard-text="<?= /* @noEscape */ $qrCodeText; ?>">
                    <?= /* @noEscape */ __('Copy Pix') ?>
                </button>
            </p>
        </div>
    </div>

</div>

<?php
$scriptString = <<<script
require([
    'jquery',
    'mage/mage'
], function($){

    $('.pix-button-copy').on('click', function(e){
        e.preventDefault();
        var text = this.dataset.clipboardText;
        navigator.clipboard.writeText(text).then(function(){

            $('.pix-qr-code-text').addClass('copied');
            window.setTimeout(function(){
                $('.pix-qr-code-text').removeClass('copied');
            }, 5000);

        }, function(err) {

            alert(err.message);
            console.error('Could not copy pix text: ', err);

        });
    });

});
script;
?>
<?= /* @noEscape */ $secureRenderer->renderTag('script', [], $scriptString, false) ?>
